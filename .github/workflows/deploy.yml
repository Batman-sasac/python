name: Deploy to EC2

on:
  push:
    branches:
      - main   # main ë¸Œëœì¹˜ì— push í•˜ë©´ ìë™ ì‹¤í–‰

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸš€ Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
        run: |
          ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << EOF
            set -e

            echo "ğŸ“‚ í”„ë¡œì íŠ¸ í´ë” ì´ë™"
            cd $PROJECT_PATH

            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ pull"
            git pull origin main

            echo "ğŸ³ ë„ì»¤ ë¹Œë“œ"
            docker-compose build

            echo "ğŸ”„ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘"
            docker-compose down
            docker-compose up -d

            echo "âœ… ë°°í¬ ì™„ë£Œ"
          EOF
