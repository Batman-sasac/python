name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸš€ Deploy to EC2
        env:
          # SSH ì ‘ì† ì •ë³´
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
          
          # ì¹´ì¹´ì˜¤ ê´€ë ¨
          KAKAO_NATIVE_APP_KEY: ${{ secrets.KAKAO_NATIVE_APP_KEY }}
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_REDIRECT_URI: ${{ secrets.KAKAO_REDIRECT_URI }}
          
          # ë„¤ì´ë²„ ê´€ë ¨
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_REDIRECT_URI: ${{ secrets.NAVER_REDIRECT_URI }}
          
          # ê¸°íƒ€ ì„œë¹„ìŠ¤ ë° DB
          CLOVA_OCR_SECRET: ${{ secrets.CLOVA_OCR_SECRET }}
          CLOVA_OCR_URL: ${{ secrets.CLOVA_OCR_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        run: |
          ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << EOF
            set -e

            echo "ğŸ“‚ í”„ë¡œì íŠ¸ í´ë” ì´ë™"
            cd $PROJECT_PATH

            echo "ğŸ”‘ .env íŒŒì¼ ìƒì„± ë° í‚¤ ì—…ë°ì´íŠ¸"
            # ì²« ë²ˆì§¸ ì¤„ì€ > ë¥¼ ì‚¬ìš©í•´ íŒŒì¼ì„ ìƒˆë¡œ ë§Œë“¤ê³ , ì´í›„ëŠ” >> ë¡œ ë‚´ìš©ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
            echo "KAKAO_NATIVE_APP_KEY=$KAKAO_NATIVE_APP_KEY" > .env
            echo "KAKAO_REST_API_KEY=$KAKAO_REST_API_KEY" >> .env
            echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
            echo "KAKAO_REDIRECT_URI=$KAKAO_REDIRECT_URI" >> .env
            echo "NAVER_CLIENT_ID=$NAVER_CLIENT_ID" >> .env
            echo "NAVER_CLIENT_SECRET=$NAVER_CLIENT_SECRET" >> .env
            echo "NAVER_REDIRECT_URI=$NAVER_REDIRECT_URI" >> .env
            echo "CLOVA_OCR_SECRET=$CLOVA_OCR_SECRET" >> .env
            echo "CLOVA_OCR_URL=$CLOVA_OCR_URL" >> .env
            echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env
            echo "SUPABASE_URL=$SUPABASE_URL" >> .env
            echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" >> .env
            echo "JWT_SECRET_KEY=$JWT_SECRET_KEY" >> .env
            # JSON í˜•íƒœì¼ ìˆ˜ ìˆëŠ” FirebaseëŠ” ë”°ì˜´í‘œë¡œ ê°ì‹¸ì„œ ë„£ìŠµë‹ˆë‹¤.
            echo "FIREBASE_CREDENTIALS='$FIREBASE_CREDENTIALS'" >> .env

            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ pull"
            git pull origin main

            echo "ğŸ³ ë„ì»¤ ë¹Œë“œ"
            docker-compose build

            echo "ğŸ”„ ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘"
            docker-compose down
            docker-compose up -d

            echo "âœ… ëª¨ë“  í™˜ê²½ë³€ìˆ˜ê°€ ë°˜ì˜ë˜ì–´ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          EOF
