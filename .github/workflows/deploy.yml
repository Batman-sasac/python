name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸ” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: ğŸš€ Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
          KAKAO_NATIVE_APP_KEY: ${{ secrets.KAKAO_NATIVE_APP_KEY }}
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_REDIRECT_URI: ${{ secrets.KAKAO_REDIRECT_URI }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_REDIRECT_URI: ${{ secrets.NAVER_REDIRECT_URI }}
          CLOVA_OCR_SECRET: ${{ secrets.CLOVA_OCR_SECRET }}
          CLOVA_OCR_URL: ${{ secrets.CLOVA_OCR_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        run: |
          ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << EOF
            set -e

            # ğŸ’¡ ë„ì»¤ API ë²„ì „ í˜¸í™˜ì„± ë¬¸ì œ í•´ê²°ì„ ìœ„í•œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
            export DOCKER_API_VERSION=1.44

            echo "ğŸ“‚ í”„ë¡œì íŠ¸ í´ë” ì´ë™"
            cd $PROJECT_PATH

            echo "ğŸ”‘ .env íŒŒì¼ ìƒì„± ë° í‚¤ ì—…ë°ì´íŠ¸"
            echo "KAKAO_NATIVE_APP_KEY=$KAKAO_NATIVE_APP_KEY" > .env
            echo "KAKAO_REST_API_KEY=$KAKAO_REST_API_KEY" >> .env
            echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
            echo "KAKAO_REDIRECT_URI=$KAKAO_REDIRECT_URI" >> .env
            echo "NAVER_CLIENT_ID=$NAVER_CLIENT_ID" >> .env
            echo "NAVER_CLIENT_SECRET=$NAVER_CLIENT_SECRET" >> .env
            echo "NAVER_REDIRECT_URI=$NAVER_REDIRECT_URI" >> .env
            echo "CLOVA_OCR_SECRET=$CLOVA_OCR_SECRET" >> .env
            echo "CLOVA_OCR_URL=$CLOVA_OCR_URL" >> .env
            echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env
            echo "SUPABASE_URL=$SUPABASE_URL" >> .env
            echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" >> .env
            echo "JWT_SECRET_KEY=$JWT_SECRET_KEY" >> .env
            echo "FIREBASE_CREDENTIALS='$FIREBASE_CREDENTIALS'" >> .env

            echo "ğŸ“¥ ìµœì‹  ì½”ë“œ pull"
            git pull origin main

            echo "ğŸ§¹ ì„œë²„ ìš©ëŸ‰ í™•ë³´ (ë¯¸ì‚¬ìš© ë„ì»¤ ë¦¬ì†ŒìŠ¤ ì‚­ì œ)"
            # ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì»¨í…Œì´ë„ˆ, ë„¤íŠ¸ì›Œí¬, ì´ë¯¸ì§€, ë¹Œë“œ ìºì‹œë¥¼ ê°•ì œë¡œ ì‚­ì œí•˜ì—¬ ìš©ëŸ‰ í™•ë³´
            docker system prune -af

            echo "ğŸ³ ë„ì»¤ ë¹Œë“œ ë° ì¬ì‹œì‘"
            # ìš©ëŸ‰ì´ ë¶€ì¡±í•  ë•ŒëŠ” buildì™€ upì„ ë™ì‹œì— í•˜ëŠ” ê²ƒì´ ì•ˆì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
            docker compose down
            docker compose up --build -d

            echo "âœ… ëª¨ë“  í™˜ê²½ë³€ìˆ˜ê°€ ë°˜ì˜ë˜ì–´ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!"
          EOF
