name: Deploy to EC2

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: π“¥ Checkout repository
        uses: actions/checkout@v3

      - name: π” Setup SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.EC2_SSH_KEY }}

      - name: π€ Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          PROJECT_PATH: ${{ secrets.PROJECT_PATH }}
          KAKAO_NATIVE_APP_KEY: ${{ secrets.KAKAO_NATIVE_APP_KEY }}
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          KAKAO_CLIENT_SECRET: ${{ secrets.KAKAO_CLIENT_SECRET }}
          KAKAO_REDIRECT_URI: ${{ secrets.KAKAO_REDIRECT_URI }}
          NAVER_CLIENT_ID: ${{ secrets.NAVER_CLIENT_ID }}
          NAVER_CLIENT_SECRET: ${{ secrets.NAVER_CLIENT_SECRET }}
          NAVER_REDIRECT_URI: ${{ secrets.NAVER_REDIRECT_URI }}
          CLOVA_OCR_SECRET: ${{ secrets.CLOVA_OCR_SECRET }}
          CLOVA_OCR_URL: ${{ secrets.CLOVA_OCR_URL }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
          JWT_SECRET_KEY: ${{ secrets.JWT_SECRET_KEY }}
          FIREBASE_CREDENTIALS: ${{ secrets.FIREBASE_CREDENTIALS }}
        run: |
          ssh -o StrictHostKeyChecking=no $EC2_USER@$EC2_HOST << EOF
            set -e

            # π’΅ λ„μ»¤ API λ²„μ „ νΈν™μ„± λ¬Έμ  ν•΄κ²°μ„ μ„ν• ν™κ²½λ³€μ μ„¤μ •
            export DOCKER_API_VERSION=1.44

            echo "π“‚ ν”„λ΅μ νΈ ν΄λ” μ΄λ™"
            cd $PROJECT_PATH

            echo "π”‘ .env νμΌ μƒμ„± λ° ν‚¤ μ—…λ°μ΄νΈ"
            echo "KAKAO_NATIVE_APP_KEY=$KAKAO_NATIVE_APP_KEY" > .env
            echo "KAKAO_REST_API_KEY=$KAKAO_REST_API_KEY" >> .env
            echo "KAKAO_CLIENT_SECRET=$KAKAO_CLIENT_SECRET" >> .env
            echo "KAKAO_REDIRECT_URI=$KAKAO_REDIRECT_URI" >> .env
            echo "NAVER_CLIENT_ID=$NAVER_CLIENT_ID" >> .env
            echo "NAVER_CLIENT_SECRET=$NAVER_CLIENT_SECRET" >> .env
            echo "NAVER_REDIRECT_URI=$NAVER_REDIRECT_URI" >> .env
            echo "CLOVA_OCR_SECRET=$CLOVA_OCR_SECRET" >> .env
            echo "CLOVA_OCR_URL=$CLOVA_OCR_URL" >> .env
            echo "OPENAI_API_KEY=$OPENAI_API_KEY" >> .env
            echo "SUPABASE_URL=$SUPABASE_URL" >> .env
            echo "SUPABASE_ANON_KEY=$SUPABASE_ANON_KEY" >> .env
            echo "JWT_SECRET_KEY=$JWT_SECRET_KEY" >> .env
            echo "FIREBASE_CREDENTIALS='$FIREBASE_CREDENTIALS'" >> .env

            echo "π“¥ μµμ‹  μ½”λ“ pull"
            git pull origin main

            echo "π³ λ„μ»¤ λΉλ“ λ° μ¬μ‹μ‘ (μµμ‹  λ…λ Ήμ–΄ μ‚¬μ©)"
            # docker-compose build λ€μ‹  ν•μ΄ν” μ—†λ” docker compose λ…λ Ήμ–΄λ¥Ό κ¶μ¥ν•©λ‹λ‹¤.
            docker compose build
            docker compose down
            docker compose up -d

            echo "β… λ¨λ“  ν™κ²½λ³€μκ°€ λ°μλμ–΄ λ°°ν¬κ°€ μ™„λ£λμ—μµλ‹λ‹¤!"
          EOF
