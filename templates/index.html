<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŠ¤ë§ˆíŠ¸ ë³µìŠµ ë…¸íŠ¸ ì œì‘ê¸°</title>
    <style>
        body {
            font-family: 'Pretendard', sans-serif;
            padding: 40px;
            line-height: 1.6;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #2c3e50;
        }

        .setup-section {
            background: #e9ecef;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        select,
        input[type="text"],
        input[type="file"] {
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }

        .btn {
            cursor: pointer;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            font-weight: bold;
            transition: 0.3s;
        }

        .btn-ocr {
            background-color: #007bff;
            color: white;
        }

        .btn-blank {
            background-color: #ffc107;
            color: #212529;
        }

        .btn-save {
            background-color: #28a745;
            color: white;
            float: right;
        }

        .btn:hover {
            opacity: 0.8;
        }

        #result {
            margin-top: 20px;
            min-height: 300px;
            border: 2px dashed #adb5bd;
            padding: 25px;
            background: #fff;
            white-space: pre-wrap;
            word-break: break-all;
            font-size: 1.1rem;
        }

        #status {
            margin-top: 10px;
            font-size: 0.9rem;
            color: #666;
            font-style: italic;
        }

        /* ë¹ˆì¹¸ ìŠ¤íƒ€ì¼ */
        .blank-span {
            border-bottom: 2px solid #000;
            background-color: #fff9db;
            padding: 0 8px;
            margin: 0 2px;
            font-weight: bold;
            color: #d9480f;
        }
    </style>
</head>

<body>

    <div class="container">
        <h1>ğŸ“š ìŠ¤ë§ˆíŠ¸ ë³µìŠµ ë…¸íŠ¸ ì œì‘ê¸°</h1>

        <div class="setup-section">
            <select id="subjectSelect">
                <option value="">ê³¼ëª© ì„ íƒ</option>
                <option value="êµ­ì–´">êµ­ì–´</option>
                <option value="ì˜ì–´">ì˜ì–´</option>
                <option value="ìˆ˜í•™">ìˆ˜í•™</option>
                <option value="ì‚¬íšŒ">ì‚¬íšŒ</option>
                <option value="ê³¼í•™">ê³¼í•™</option>
            </select>
            <input type="file" id="fileInput" accept="image/*,application/pdf">
            <button class="btn btn-ocr" onclick="startOCR()">í…ìŠ¤íŠ¸ ì¶”ì¶œ</button>
        </div>

        <div style="margin-bottom: 10px;">
            <button class="btn btn-blank" onclick="makeBlank()">ğŸ’¡ ë“œë˜ê·¸ ì˜ì—­ ë¹ˆì¹¸ ë§Œë“¤ê¸°</button>
            <button class="btn btn-save" onclick="verifyData()">ğŸš€ ì„œë²„ë¡œ ë°ì´í„° ì „ì†¡(ê²€ì¦)</button>
        </div>

        <div id="status">íŒŒì¼ì„ ì—…ë¡œë“œí•˜ê³  [í…ìŠ¤íŠ¸ ì¶”ì¶œ]ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</div>
        <div id="result" contenteditable="false">OCR ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
    </div>

    <script>
        let originalText = ""; // ì›ë³¸ ë³´ì¡´ìš©
        let answerList = [];   // ì •ë‹µ ë‹¨ì–´ë“¤ì„ ë‹´ì„ ë°°ì—´

        // 1. OCR ì‹¤í–‰ í•¨ìˆ˜
        async function startOCR() {
            const fileInput = document.getElementById('fileInput');
            const status = document.getElementById('status');
            const resultDiv = document.getElementById('result');

            if (!fileInput.files[0]) {
                alert("íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”!");
                return;
            }

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            status.innerText = "â³ GPTê°€ ì´ë¯¸ì§€ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”.";

            try {
                const response = await fetch("http://127.0.0.1:8000/ocr", {
                    method: "POST",
                    body: formData
                });
                const data = await response.json();

                if (data.status === "success") {
                    originalText = data.text; // ì›ë³¸ ë°ì´í„° ì €ì¥
                    answerList = []; // ë°°ì—´ ì´ˆê¸°í™”
                    resultDiv.innerText = data.text;
                    status.innerText = "âœ… ë¶„ì„ ì™„ë£Œ! ì¤‘ìš” ë‹¨ì–´ë¥¼ ë“œë˜ê·¸í•œ ë’¤ [ë¹ˆì¹¸ ë§Œë“¤ê¸°]ë¥¼ ëˆ„ë¥´ì„¸ìš”.";
                } else {
                    status.innerText = "âŒ ì˜¤ë¥˜: " + data.message;
                }
            } catch (error) {
                status.innerText = "âŒ ì„œë²„ ì—°ê²° ì‹¤íŒ¨";
                console.error(error);
            }
        }

        // 2. ë“œë˜ê·¸ í›„ ë¹ˆì¹¸ ìƒì„± ë° ë°°ì—´ ì¶”ê°€
        function makeBlank() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            if (selectedText) {
                // ë°°ì—´ì— ì •ë‹µ ë‹¨ì–´ ì¶”ê°€
                answerList.push(selectedText);

                const range = selection.getRangeAt(0);
                const span = document.createElement("span");

                // ì‹œê°ì ìœ¼ë¡œ ë¹ˆì¹¸ì„ì„ ì•Œ ìˆ˜ ìˆê²Œ ìŠ¤íƒ€ì¼ ì ìš©
                span.className = "blank-span";
                span.innerText = `(${answerList.length})`; // ëª‡ ë²ˆì§¸ ë¹ˆì¹¸ì¸ì§€ í‘œì‹œ

                range.deleteContents();
                range.insertNode(span);

                // ë“œë˜ê·¸ í•´ì œ
                selection.removeAllRanges();

                console.log("í˜„ì¬ê¹Œì§€ ì¶”ì¶œëœ ì •ë‹µ ë¦¬ìŠ¤íŠ¸:", answerList);
            } else {
                alert("ë¹ˆì¹¸ìœ¼ë¡œ ë§Œë“¤ ë‹¨ì–´ë¥¼ ë§ˆìš°ìŠ¤ë¡œ ë“œë˜ê·¸í•˜ì„¸ìš”!");
            }
        }

        // 3. ì„œë²„ë¡œ ì „ì†¡í•˜ì—¬ ë°ì´í„° í™•ì¸ (ìµœì¢… ê²€ì¦)
        async function verifyData() {
            const subject = document.getElementById('subjectSelect').value || "ë¯¸ì§€ì • ê³¼ëª©";
            const resultDiv = document.getElementById('result');
            const quizText = resultDiv.innerText;

            if (answerList.length === 0) {
                alert("ë¹ˆì¹¸ì„ í•˜ë‚˜ ì´ìƒ ë§Œë“¤ì–´ì£¼ì„¸ìš”!");
                return;
            }

            const payload = {
                subject_name: subject,
                original: originalText,
                quiz: quizText,
                answers: answerList
            };

            console.log("ì„œë²„ë¡œ ë³´ë‚¼ ìµœì¢… ë°ì´í„°:", payload);

            try {
                const response = await fetch("http://127.0.0.1:8000/save-test", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();
                alert("ì„±ê³µ: " + result.message + "\n\níŒŒì´ì¬ í„°ë¯¸ë„ ë¡œê·¸ë¥¼ í™•ì¸í•´ ë³´ì„¸ìš”!");
            } catch (error) {
                alert("ì„œë²„ ì „ì†¡ ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
                console.error(error);
            }
        }
    </script>

</body>

</html>