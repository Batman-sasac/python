<!DOCTYPE html>
<html lang="ko">

<head>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <meta charset="UTF-8">
    <title>ìŠ¤ë§ˆíŠ¸ ë³µìŠµ ìƒì„± - OCR</title>
    <style>
        .upload-box {
            border: 2px dashed #007bff;
            padding: 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #image-preview {
            display: none;
            margin: 15px auto;
            max-width: 300px;
            max-height: 400px;
            border-radius: 8px;
            object-fit: contain;
        }

        .btn {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
            margin: 5px;
        }

        .btn-ocr {
            background: #007bff;
            color: white;
        }

        #result-area {
            white-space: pre-wrap;
            /* ì¤„ë°”ê¿ˆ(\n)ê³¼ ê³µë°±ì„ ê·¸ëŒ€ë¡œ ìœ ì§€ */
            word-break: break-all;
            /* ë‹¨ì–´ê°€ ê¸¸ì–´ë„ ì˜ì—­ ë°–ìœ¼ë¡œ ë‚˜ê°€ì§€ ì•Šê²Œ í•¨ */
            line-height: 1.6;
        }

        #result-area strong {
            color: #000 !important;
            font-weight: 900 !important;
            background-color: #f0db72 !important;
            padding: 2px 4px !important;
            border-radius: 4px !important;
        }

        .blank-span {
            background: #fff3bf;
            border-bottom: 2px solid #f08c00;
            padding: 0 4px;
            font-weight: bold;
            color: #f08c00;
        }

        /* í€´ì¦ˆ ì…ë ¥ì°½ ìŠ¤íƒ€ì¼ */
        .quiz-input {
            border: none;
            border-bottom: 2px solid #007bff;
            background: #e7f1ff;
            width: 100px;
            text-align: center;
            font-weight: bold;
            margin: 0 5px;
            padding: 2px;
        }

        .correct {
            background-color: #d4edda !important;
            color: #155724 !important;
            border-bottom-color: #28a745 !important;
        }

        .wrong {
            background-color: #f8d7da !important;
            color: #721c24 !important;
            border-bottom-color: #dc3545 !important;
        }
    </style>
</head>

<body>
    <div class="container">
        <h2>ğŸ“¸ í•™ìŠµ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>
        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <p>í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”.</p>
            <input type="file" id="fileInput" accept="image/*, .pdf" style="display:none" onchange="previewImage(this)">
            <img id="image-preview" alt="ë¯¸ë¦¬ë³´ê¸°">
        </div>

        <div class="subject-selection" style="margin: 20px 0;">
            <label for="subjectName">ğŸ“š ê³¼ëª© ì„ íƒ: </label>
            <select id="subjectName" class="form-select" style="padding: 5px; border-radius: 5px;">
                <option value="êµ­ì–´">êµ­ì–´</option>
                <option value="ì˜ì–´">ì˜ì–´</option>
                <option value="ìˆ˜í•™">ìˆ˜í•™</option>
                <option value="ì‚¬íšŒ">ì‚¬íšŒ</option>
                <option value="ê³¼í•™">ê³¼í•™</option>
                <option value="ê¸°íƒ€">ì§ì ‘ ì…ë ¥</option>
            </select>
            <input type="text" id="customSubject" placeholder="ê³¼ëª©ëª… ì§ì ‘ ì…ë ¥" style="display:none; margin-top:5px;">
        </div>
        <input type="text" id="studyName" placeholder="í•™ìŠµëª… ì…ë ¥">

        <button class="btn btn-ocr" onclick="startOCR()">í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹œì‘</button>
        <div id="result-area">í…ìŠ¤íŠ¸ê°€ ì¶”ì¶œë˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

        <div id="control-buttons" style="margin-top: 15px;">
            <button class="btn" style="background: #ffc107;" onclick="makeBlank()">ë¹ˆì¹¸ ìƒì„±</button>
            <button class="btn" id="study-btn" style="background: #28a745; color: white;"
                onclick="saveAndStartLearning()">í•™ìŠµ ì‹œì‘</button>
        </div>

        <div id="pdf-controls"
            style="margin: 15px 0; display: none; text-align: center; background: #f8f9fa; padding: 10px; border-radius: 8px;">
            <button class="btn" style="background: #6c757d; color: white;" onclick="changePage(-1)">â—€ ì´ì „ í˜ì´ì§€</button>
            <span id="page-indicator" style="font-weight: bold; margin: 0 15px; font-size: 1.1em;">1 / 1</span>
            <button class="btn" style="background: #6c757d; color: white;" onclick="changePage(1)">ë‹¤ìŒ í˜ì´ì§€ â–¶</button>
        </div>
    </div>

    <script>


        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            const file = input.files[0];

            if (file) {
                // PDF íŒŒì¼ì¸ ê²½ìš° ë¯¸ë¦¬ë³´ê¸°ë¥¼ í…ìŠ¤íŠ¸ë‚˜ ì•„ì´ì½˜ìœ¼ë¡œ ëŒ€ì²´í•˜ê±°ë‚˜ ìˆ¨ê¸¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                if (file.type === "application/pdf") {
                    preview.style.display = 'none';
                    console.log("PDF íŒŒì¼ì´ ì„ íƒë˜ì—ˆìŠµë‹ˆë‹¤. ë¯¸ë¦¬ë³´ê¸°ëŠ” ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    preview.src = e.target.result;
                    preview.style.display = 'block'; // ìˆ¨ê²¨ì ¸ ìˆë˜ ì´ë¯¸ì§€ë¥¼ í‘œì‹œ
                }
                reader.readAsDataURL(file);
            } else {
                preview.src = "";
                preview.style.display = 'none';
            }
        }
        // 1. ì „ì—­ ë³€ìˆ˜ ì„ ì–¸ë¶€ (í•¨ìˆ˜ ë°– ìƒë‹¨ì— ìœ„ì¹˜í•´ì•¼ í•¨)
        let g_pdfPages = [];
        let g_keywords = [];
        let g_originalText = "";
        let answerList = [];
        let g_currentPageIndex = 0;
        let g_pagesKeywords = [];
        let g_userAnswers = {};

        async function startOCR() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) return alert("íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!");

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);

            const resultArea = document.getElementById('result-area');
            resultArea.innerHTML = "ğŸ” íŒŒì¼ ë¶„ì„ ì¤‘... PDFëŠ” ìµœëŒ€ 1ë¶„ ì •ë„ ì†Œìš”";

            try {
                const res = await fetch("/ocr", {
                    method: "POST",
                    body: formData
                });
                const data = await res.json();

                if (data.status === "success") {
                    // [ì¤‘ìš” ìˆ˜ì •] g_pdgPages -> g_pdfPages ì˜¤íƒ€ ìˆ˜ì •
                    g_pdfPages = data.pages || [data.original_text];
                    g_originalText = data.original_text;


                    // ë°±ì—ì„œ ë³´ë‚¸ í˜ì´ì§€ë±” í‚¤ì›Œë“œ ì €ì¥
                    g_pagesKeywords = data.pages_keywords || [];
                    g_keywords = data.keywords || []; // ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹

                    g_currentPageIndex = 0; // ì‹œì‘ ì‹œ ì²« í˜ì´ì§€ ì´ˆê¸°í™”
                    renderCurrentPage();
                } else {
                    resultArea.innerText = "ì—ëŸ¬: " + data.message;
                }
            } catch (e) {
                resultArea.innerHTML = `âŒ ì—°ê²° ì‹¤íŒ¨: ${e.message}<br>íŒŒì¼ ìš©ëŸ‰ì´ ë„ˆë¬´ í¬ê±°ë‚˜ ì„œë²„ ì‘ë‹µ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.`;
            }
        }

        let g_pageQuizzes = {};
        let g_pageAnswers = {};
        let isLearningMode = false;

        function renderCurrentPage() {
            const resultArea = document.getElementById('result-area');
            if (!g_pdfPages || g_pdfPages.length === 0) return;

            // --- [STEP 1: ë°ì´í„° ê²°ì •] ---
            // ì´ë¯¸ ë¹ˆì¹¸ì„ ë§Œë“  ì ì´ ìˆëŠ” í˜ì´ì§€ë¼ë©´ ê·¸ HTMLì„ ì‚¬ìš©í•˜ê³ , ì—†ìœ¼ë©´ ì›ë³¸ì„ ê°€ê³µí•©ë‹ˆë‹¤.
            let contentToRender = "";

            if (g_pageQuizzes[g_currentPageIndex]) {
                contentToRender = g_pageQuizzes[g_currentPageIndex];
                answerList = g_pageAnswers[g_currentPageIndex] || [];
            } else {
                let rawContent = g_pdfPages[g_currentPageIndex];
                if (typeof rawContent === 'object' && rawContent !== null) {
                    rawContent = rawContent.text || rawContent.content || JSON.stringify(rawContent);
                }

                // í‚¤ì›Œë“œ ê°•ì¡°(Strong) ì²˜ë¦¬
                const currentPageKeywords = (g_pagesKeywords && g_pagesKeywords[g_currentPageIndex])
                    ? g_pagesKeywords[g_currentPageIndex] : [];

                if (currentPageKeywords.length > 0) {
                    const sortedKeywords = [...currentPageKeywords]
                        .filter(w => w.trim().length >= 2)
                        .sort((a, b) => b.length - a.length);

                    if (sortedKeywords.length > 0) {
                        const escaped = sortedKeywords.map(w => w.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'));
                        const pattern = new RegExp(`(${escaped.join('|')})`, 'g');
                        rawContent = rawContent.replace(pattern, '<strong>$1</strong>');
                    }
                }
                contentToRender = rawContent;
                answerList = [];
            }

            // --- [STEP 2: í™”ë©´ ë°˜ì˜] ---
            resultArea.innerHTML = contentToRender;

            // --- [STEP 3: í•™ìŠµ ëª¨ë“œ ì²´í¬] ---
            // [ì¤‘ìš”] í˜ì´ì§€ë¥¼ ë„˜ê²¼ì„ ë•Œ í•™ìŠµ ëª¨ë“œ ìƒíƒœë¼ë©´, ë°©ê¸ˆ ê·¸ë¦° spanë“¤ì„ inputìœ¼ë¡œ ì¦‰ì‹œ êµì²´í•©ë‹ˆë‹¤.
            if (isLearningMode) {
                convertSpansToInputs(); // span -> input êµì²´ í•¨ìˆ˜ í˜¸ì¶œ
            }

            updatePageUI();
        }

        function changePage(direction) {

            // í˜ì´ì§€ë¥¼ ë– ë‚˜ê¸° ì „ì— ì‚¬ìš©ìê°€ ì…ë ¥í•œ ê°’ ì €ì¥
            if (isLearningMode) {
                const inputs = document.querySelectorAll('.quiz-input');
                g_userAnswers[g_currentPageIndex] = Array.from(inputs).map(input => input.value);
            }

            const newIndex = g_currentPageIndex + direction;
            if (newIndex >= 0 && newIndex < g_pdfPages.length) {
                g_currentPageIndex = newIndex;
                renderCurrentPage();
            }
        }


        function updatePageUI() {
            const controls = document.getElementById('pdf-controls');
            const indicator = document.getElementById('page-indicator');

            if (g_pdfPages && g_pdfPages.length > 1) {
                controls.style.display = 'block';
                indicator.innerText = `${g_currentPageIndex + 1} / ${g_pdfPages.length}`;
            } else {
                controls.style.display = 'none';
            }
        }

        function makeBlank() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            if (!selectedText) return alert("ë‹¨ì–´ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”!");

            answerList.push(selectedText);
            const range = selection.getRangeAt(0);
            const span = document.createElement("span");
            span.className = "blank-span";
            span.dataset.answer = selectedText;
            span.innerText = `(${answerList.length})`;

            range.deleteContents();
            range.insertNode(span);
            answerList.push(selectedText);
            selection.removeAllRanges();

            const resultArea = document.getElementById('result-area');
            g_pageQuizzes[g_currentPageIndex] = resultArea.innerHTML;
            g_pageAnswers[g_currentPageIndex] = [...answerList];
        }

        function convertSpansToInputs() {
            const spans = document.querySelectorAll('.blank-span');
            spans.forEach((span, index) => {
                const input = document.createElement('input');
                input.type = 'text';
                input.className = 'quiz-input';
                input.dataset.answer = span.dataset.answer; // ì •ë‹µ ë°ì´í„° ìœ ì§€
                input.placeholder = span.innerText; // (1), (2) ë“±ì„ í‘œì‹œ

                if (g_userAnswers[g_currentPageIndex] && g_userAnswers[g_currentPageIndex][index]) {

                    // ì‚¬ìš©ìê°€ ì´ë¯¸ ì…ë ¥í–ˆë˜ ê°’ì´ ìˆë‹¤ë©´ ìœ ì§€í•˜ê³  ì‹¶ì„ ë•Œ (ì„ íƒ ì‚¬í•­)
                    input.value = g_userAnswers[g_currentPageIndex]?.[index] || "";

                }

                span.parentNode.replaceChild(input, span);
            });
        }


        async function saveAndStartLearning() {

            //1. í˜„ì¬ í˜ì´ì§€ ìƒíƒœ ë¨¼ì € ì €ì¥ 
            const resultArea = document.getElementById('result-area');
            g_pageQuizzes[g_currentPageIndex] = resultArea.innerHTML;
            g_pageAnswers[g_currentPageIndex] = [...answerList];

            isLearningMode = true; // í•™ìŠµ ëª¨ë“œ í™œì„±í™”
            convertSpansToInputs(); // í˜„ì¬ í™”ë©´ ë³€í™˜


            //2. ëª¨ë“  í˜ì´ì§€ì˜ ì •ë‹µì„ í•©ì¹¨
            const allAnswers = Object.values(g_pageAnswers).flat();

            // ë§Œì•½ ë“œë˜ê·¸ë§Œ í•˜ê³  ì•„ì§ ë‹¤ë¥¸ í˜ì´ì§€ë¡œ ì•ˆ ë„˜ì–´ê°€ì„œ g_pageAnswersì— ì•ˆ ë‹´ê²¼ì„ ê²½ìš°ë¥¼ ëŒ€ë¹„í•´ 
            // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ë¹ˆì¹¸ë“¤ë„ ì²´í¬í•©ë‹ˆë‹¤.
            const currentBlanks = document.querySelectorAll('.blank-span');
            if (allAnswers.length === 0 && currentBlanks.length === 0) return alert("ë¹ˆì¹¸ì„ ë¨¼ì € ë§Œë“¤ì–´ì£¼ì„¸ìš”!");

            // ê³¼ëª©ëª… í•™ìŠµëª… ì •ë¦¬
            const subjectSelect = document.getElementById('subjectName');
            let subjectName = subjectSelect.value;
            if (subjectName === "ê¸°íƒ€") {
                subjectName = document.getElementById('customSubject').value || "ë¯¸ì§€ì • ê³¼ëª©";
            }

            // [ì¶”ê°€] ì‚¬ìš©ìê°€ ì…ë ¥í•œ í•™ìŠµëª… ê°€ì ¸ì˜¤ê¸°
            const studyNameInput = document.getElementById('studyName');
            const studyName = studyNameInput.value.trim() || `${subjectName} í•™ìŠµ (${new Date().toLocaleDateString()})`;

            try {
                const response = await fetch("/ocr/save-test", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        subject_name: subjectName,
                        study_name: studyName,
                        original_text: g_pdfPages,
                        answers: allAnswers,
                        quiz: g_pageQuizzes             // ëª¨ë“  í˜ì´ì§€ì˜ ì •ë‹µ ë¦¬ìŠ¤íŠ¸ í•©ë³¸
                    })
                });

                const result = await response.json();

                if (result.status === "success") {
                    document.getElementById('result-area').dataset.quizId = result.quiz_id;
                    console.log(`âœ… [${subjectName}] ì „ì²´ ì €ì¥ ì„±ê³µ! ID: ${result.quiz_id}`);

                    // í˜„ì¬ í™”ë©´ì— ë³´ì´ëŠ” ë¹ˆì¹¸ë“¤ì„ inputìœ¼ë¡œ êµì²´
                    const currentVisibleBlanks = document.querySelectorAll('.blank-span');
                    currentVisibleBlanks.forEach((span, index) => {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'quiz-input';
                        input.dataset.correctAnswer = span.dataset.answer;
                        input.placeholder = `(${index})`;
                        span.parentNode.replaceChild(input, span);
                    });

                    const studyBtn = document.getElementById('study-btn');
                    studyBtn.innerText = "ğŸ¯ ì±„ì í•˜ê¸°";
                    studyBtn.onclick = checkAnswers;
                } else {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + result.message);
                    console.log("ì €ì¥ ì‹¤íŒ¨: " + result.message)
                }
            } catch (e) {
                console.error("ì„œë²„ ì—°ê²° ì‹¤íŒ¨:", e);
            }
        }

        async function checkAnswers() {
            // 1. í˜„ì¬ í˜ì´ì§€ì— ì…ë ¥ëœ ê°’ë¶€í„° g_userAnswersì— ìµœì¢… ì €ì¥
            const currentInputs = document.querySelectorAll('.quiz-input');
            if (currentInputs.length > 0) {
                g_userAnswers[g_currentPageIndex] = Array.from(currentInputs).map(input => input.value);
            }

            let totalScore = 0;
            let totalQuestions = 0;
            const allUserAnswers = [];
            const allCorrectAnswers = [];

            // 2. [í•µì‹¬] ì „ì²´ í˜ì´ì§€ ë°ì´í„°ë¥¼ ìˆœíšŒí•˜ë©° ì„±ì  ê³„ì‚°
            Object.keys(g_pageAnswers).forEach(pageIdx => {
                const correctPageAnswers = g_pageAnswers[pageIdx]; // í•´ë‹¹ í˜ì´ì§€ ì •ë‹µ ë°°ì—´
                const userPageAnswers = g_userAnswers[pageIdx] || []; // í•´ë‹¹ í˜ì´ì§€ ìœ ì € ë‹µì•ˆ ë°°ì—´

                totalQuestions += correctPageAnswers.length;

                correctPageAnswers.forEach((correct, imgIdx) => {
                    const userAns = (userPageAnswers[imgIdx] || "").trim();
                    const correctAns = correct.trim();

                    allUserAnswers.push(userAns);
                    allCorrectAnswers.push(correctAns);

                    if (userAns === correctAns) {
                        totalScore++;
                    }
                });
            });

            // 3. í˜„ì¬ í™”ë©´(DOM) ì‹œê°ì  í”¼ë“œë°± ë°˜ì˜
            currentInputs.forEach(input => {
                const uAns = input.value.trim();
                const cAns = input.dataset.correctAnswer;

                if (uAns === cAns) {
                    input.classList.add('correct');
                } else {
                    input.classList.add('wrong');
                    input.value = `${uAns} (ì •ë‹µ: ${cAns})`;
                }
                input.disabled = true;
            });

            // 4. ì „ì—­ ì±„ì  ëª¨ë“œ í™œì„±í™” (í˜ì´ì§€ ì´ë™ ì‹œ ìƒ‰ìƒ ìœ ì§€ìš©)
            isGradedMode = true;

            alert(`ì±„ì  ì™„ë£Œ! ì´ ${totalQuestions}ê°œ ì¤‘ ${totalScore}ê°œ ë§í˜”ìŠµë‹ˆë‹¤.`);

            // 5. ì„œë²„ ë°ì´í„° ì „ì†¡
            const quizId = document.getElementById('result-area').dataset.quizId;
            if (quizId) {
                try {
                    const response = await fetch("/study/grade", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            quiz_id: parseInt(quizId),
                            user_answers: allUserAnswers, // ì „ì²´ í˜ì´ì§€ ë‹µë³€ í•©ë³¸
                            answer: allCorrectAnswers     // ì „ì²´ í˜ì´ì§€ ì •ë‹µ í•©ë³¸
                        })
                    });
                    const result = await response.json();
                    if (result.status === "success") console.log("âœ… DB ì—…ë°ì´íŠ¸ ì„±ê³µ");
                } catch (e) {
                    console.error("ì„œë²„ ì—°ê²° ì—ëŸ¬:", e);
                }
            }

            const studyBtn = document.getElementById('study-btn');
            studyBtn.innerText = "ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ë‹¤ì‹œí•˜ê¸°";
            studyBtn.onclick = () => location.reload();
        }
    </script>
</body>

</html>