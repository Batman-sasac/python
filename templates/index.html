<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <title>ìŠ¤ë§ˆíŠ¸ ë³µìŠµ - íŒŒì¼ ì—…ë¡œë“œ</title>
    <style>
        .upload-box {
            border: 2px dashed #007bff;
            padding: 30px;
            text-align: center;
            border-radius: 10px;
            background: #f8f9fa;
            cursor: pointer;
            margin-bottom: 20px;
        }

        #image-preview {
            max-width: 100%;
            height: auto;
            display: none;
            margin-top: 15px;
            border-radius: 5px;
        }

        .btn {
            padding: 10px 20px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            font-weight: bold;
        }

        .btn-ocr {
            background: #007bff;
            color: white;
        }

        #result-area {
            border: 1px solid #ddd;
            padding: 20px;
            min-height: 150px;
            white-space: pre-wrap;
            margin-top: 20px;
        }

        .blank-span {
            background: #fff3bf;
            border-bottom: 2px solid #f08c00;
            padding: 0 4px;
        }

        .quiz-input {
            border: none;
            border-bottom: 2px solid #007bff;
            background-color: #fff3bf;
            width: 80px;
            text-align: center;
            font-size: 1rem;
            font-weight: bold;
            margin: 0 5px;
            outline: none;
        }

        .quiz-input:focus {
            background-color: #ffe066;
            border-bottom-color: #f08c00;
        }
    </style>
</head>

<body>

    <div class="container">
        <h2>ğŸ“¸ í•™ìŠµ ì´ë¯¸ì§€ ì—…ë¡œë“œ</h2>

        <div class="upload-box" onclick="document.getElementById('fileInput').click()">
            <p>í´ë¦­í•˜ì—¬ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê±°ë‚˜ íŒŒì¼ì„ ë“œë˜ê·¸í•˜ì„¸ìš”.</p>
            <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="previewImage(this)">
            <img id="image-preview" alt="ë¯¸ë¦¬ë³´ê¸°">
        </div>

        <div class="header-section">
            <select id="subjectSelect">
                <option value="êµ­ì–´">êµ­ì–´</option>
                <option value="ì˜ì–´">ì˜ì–´</option>
                <option value="ìˆ˜í•™">ìˆ˜í•™</option>
            </select>
            <button class="btn btn-ocr" onclick="startOCR()">í…ìŠ¤íŠ¸ ì¶”ì¶œ ì‹œì‘</button>
        </div>

        <div id="result-area">í…ìŠ¤íŠ¸ê°€ ì¶”ì¶œë˜ë©´ ì´ê³³ì— í‘œì‹œë©ë‹ˆë‹¤.</div>

        <div style="margin-top: 15px;">
            <button class="btn" style="background: #ffc107;" onclick="makeBlank()">ë¹ˆì¹¸ ìƒì„±</button>
            <button class="btn" style="background: #28a745; color: white;" onclick="saveAndStartLearning()">í•™ìŠµ ì‹œì‘ (DB
                ì €ì¥)</button>
        </div>

        <div id="submit-section"
            style="display: none; margin-top: 30px; text-align: center; border-top: 2px dashed #ddd; padding-top: 20px;">
            <p style="color: #666;">ë¬¸ì¥ ì† ë¹ˆì¹¸ì— ë‹µì„ ëª¨ë‘ ì…ë ¥í•œ í›„ ì•„ë˜ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.</p>
            <button class="btn" style="background: #007bff; color: white; width: 100%; font-size: 1.1rem;"
                onclick="submitGrade()">ë‹µì•ˆ ì œì¶œ ë° ì±„ì </button>
        </div>
    </div>

    <script>
        let originalText = "";
        let answerList = [];
        let currentQuizId = null;
        let tempCorrectAnswers = [];

        // íŒŒì¼ ë¯¸ë¦¬ë³´ê¸° ê¸°ëŠ¥
        function previewImage(input) {
            const preview = document.getElementById('image-preview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.style.display = 'block'; // ì´ë¯¸ì§€ ë³´ì´ê¸°
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        // 1. OCR í…ìŠ¤íŠ¸ ì¶”ì¶œ
        async function startOCR() {
            const fileInput = document.getElementById('fileInput');
            if (!fileInput.files[0]) return alert("íŒŒì¼ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”!");

            const formData = new FormData();
            formData.append("file", fileInput.files[0]);
            document.getElementById('result-area').innerText = "OCR ë¶„ì„ ì¤‘...";
            answerList = [];

            try {
                const res = await fetch("/ocr", { method: "POST", body: formData });
                const data = await res.json();
                if (data.status === "success") {
                    originalText = data.text;
                    document.getElementById('result-area').innerText = data.text;
                    alert("ì¶”ì¶œ ì„±ê³µ! ë‹¨ì–´ë¥¼ ë“œë˜ê·¸í•˜ê³  [ë¹ˆì¹¸ ìƒì„±]ì„ ëˆ„ë¥´ì„¸ìš”.");
                }
            } catch (e) {
                alert("ì„œë²„ ì—°ê²° ì‹¤íŒ¨");
            }
        }

        // 2. ë¹ˆì¹¸ ìƒì„± ë¡œì§
        function makeBlank() {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            if (!selectedText) return alert("ë‹¨ì–´ë¥¼ ë“œë˜ê·¸í•˜ì„¸ìš”!");

            answerList.push(selectedText);
            const range = selection.getRangeAt(0);
            const span = document.createElement("span");
            span.className = "blank-span";
            span.innerText = `(${answerList.length})`;
            range.deleteContents();
            range.insertNode(span);
            selection.removeAllRanges();
        }

        async function saveAndStartLearning() {
            if (answerList.length === 0) return alert("ë¹ˆì¹¸ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”!");
            tempCorrectAnswers = [...answerList];

            const payload = {
                subject_name: document.getElementById('subjectSelect').value,
                original: originalText,
                quiz: document.getElementById('result-area').innerText,
                answers: []
            };

            try {
                const res = await fetch("/ocr/save-test", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(payload)
                });

                const data = await res.json();

                if (data.status === "success") {
                    currentQuizId = data.quiz_id;

                    // 1. ë¹ˆì¹¸ì„ ì…ë ¥ì°½ìœ¼ë¡œ êµì²´
                    const blankSpans = document.querySelectorAll('.blank-span');
                    blankSpans.forEach((span, index) => {
                        const input = document.createElement('input');
                        input.type = 'text';
                        input.className = 'quiz-input';
                        input.placeholder = `(${index + 1})`;
                        span.parentNode.replaceChild(input, span);
                    });

                    // 2. [ê°€ì¥ ì¤‘ìš”] ìˆ¨ê²¨ì§„ ì œì¶œ ë²„íŠ¼ ì˜ì—­ì„ ê°•ì œë¡œ ë³´ì—¬ì¤Œ
                    const submitSection = document.getElementById('submit-section');
                    submitSection.style.setProperty('display', 'block', 'important');

                    // 3. ì•Œë¦¼ì°½ í‘œì‹œ
                    alert("ì €ì¥ ì™„ë£Œ! ë¹ˆì¹¸ì— ë‹µì„ ì…ë ¥í•˜ê³  í•˜ë‹¨ì˜ ì œì¶œ ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”.");

                    // 4. ë²„íŠ¼ ìœ„ì¹˜ë¡œ ìë™ ìŠ¤í¬ë¡¤
                    submitSection.scrollIntoView({ behavior: 'smooth' });
                } else {
                    alert("ì €ì¥ ì‹¤íŒ¨: " + data.message);
                }
            } catch (e) {
                console.error(e);
                alert("ì„œë²„ ì—°ê²° ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // 4. ë‹µì•ˆ ì œì¶œ ë° ì±„ì 
        async function submitGrade() {
            const inputs = document.querySelectorAll(".quiz-input");
            const userAnswers = Array.from(inputs).map(i => i.value);

            try {
                const res = await fetch("/quiz/grade", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify({
                        quiz_id: currentQuizId,
                        user_answers: userAnswers,
                        correct_answers: tempCorrectAnswers
                    })
                });
                const result = await res.json();
                if (result.status === "success") {
                    alert(`ì±„ì  ì™„ë£Œ! ì ìˆ˜: ${result.score}/${result.total}`);
                }
            } catch (e) {
                alert("ì±„ì  ì¤‘ ì˜¤ë¥˜ ë°œìƒ");
            }
        }
    </script>
</body>

</html>